<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}Aljamea-tus-Saifiyah â€“ Library Dashboard{% endblock %}</title>

  <meta name="description" content="Aljamea-tus-Saifiyah â€“ Library (Maktabat al-Jamea) dashboard, reports, and analytics.">
  <meta name="theme-color" content="#a45a26">
  <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

  <!-- Bootstrap & Datatables -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  
  <!-- Add Alkanz Font for Arabic text -->
  <link href="https://fonts.googleapis.com/css2?family=Alkanz&display=swap" rel="stylesheet">

  {% block extra_css %}{% endblock %}

  <style>
    /* ===== Custom Theme ===== */
    .navbar-custom {
      background-color: #fff8ef;
      color: #a45a26;
      border-bottom: 1px solid #e6d8c3;
    }
    .navbar-custom .navbar-brand span {
      color: #a45a26;
      font-weight: 600;
      font-size: 1.1rem;
    }
    .navbar-custom .nav-link {
      color: #a45a26 !important;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .navbar-custom .nav-link:hover,
    .navbar-custom .nav-link.active {
      color: #8c4519 !important;
      border-bottom: 2px solid #a45a26;
    }
    .navbar-custom .dropdown-menu {
      border: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .navbar-custom .dropdown-item {
      color: #6b3b16;
    }
    .navbar-custom .dropdown-item:hover {
      background-color: #f5e9db;
    }
    .navbar-nav .nav-item {
      margin-right: 0.6rem;
    }

    .btn-outline-light {
      color: #a45a26;
      border-color: #a45a26;
    }
    .btn-outline-light:hover {
      background-color: #a45a26;
      color: #fff;
    }

    /* Footer */
    footer {
      background-color: #fff8ef;
      color: #6b3b16;
      border-top: 1px solid #e6d8c3;
      font-size: 0.9rem;
    }
    footer a {
      color: #a45a26;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }

    /* Custom style for Arabic text */
    .arabic-text {
      font-family: 'Alkanz', sans-serif;
      text-align: center;
    }

    /* Make the navbar items more evenly spaced */
    .navbar-nav .nav-item {
      margin-right: 1rem;
    }

    /* Class Explorer specific styles */
    .class-explorer-link {
      background: linear-gradient(135deg, #f5e9db 0%, #e6d8c3 100%);
      border-left: 4px solid #a45a26;
    }
    .class-explorer-link:hover {
      background: linear-gradient(135deg, #e6d8c3 0%, #d4c3a8 100%);
    }

    /* Department Explorer specific styles */
    .department-explorer-link {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-left: 4px solid #1976d2;
    }
    .department-explorer-link:hover {
      background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
    }

    /* Profile avatar */
    .nav-profile-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e6d8c3;
    }

    /* Notification badge */
    #notification-badge {
      font-size: 0.6rem;
      padding: 0.2rem 0.4rem;
    }

    /* Dropdown menu adjustments */
    .dropdown-header {
      font-weight: 600;
      color: #6b3b16;
      font-size: 0.85rem;
      padding: 0.5rem 1rem;
    }

    /* Quick form styles */
    .quick-class-form .input-group,
    .quick-dept-form .input-group {
      width: 180px;
    }

    /* Department item styling */
    .department-item {
      border-left: 3px solid #1976d2;
      background-color: rgba(25, 118, 210, 0.05);
      margin: 0.25rem 0;
    }
    
    .department-item:hover {
      background-color: rgba(25, 118, 210, 0.1);
    }
    
    .department-code {
      font-weight: 600;
      font-size: 0.85rem;
      color: #1976d2;
    }
    
    .department-name {
      font-size: 0.8rem;
      color: #6c757d;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .navbar-nav .nav-item {
        margin-right: 0.5rem;
      }
      
      .navbar-nav.ms-5 {
        margin-left: 1rem !important;
      }
    }

  </style>
</head>

<body class="d-flex flex-column min-vh-100">

  {% if not hide_nav %}
  <nav class="navbar navbar-expand-lg navbar-custom shadow-sm sticky-top">
    <div class="container-fluid px-4">
      <a class="navbar-brand d-flex align-items-center" href="{{ url_for('dashboard_bp.dashboard') if session.get('logged_in') else '#' }}">
        <i class="bi bi-book-half fs-4 me-2"></i>
        <span>Aljamea-tus-Saifiyah â€“ Library</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      {% set raw_role = session.get('role') %}
      {% if raw_role is string %}
        {% set user_role = raw_role|lower %}
      {% else %}
        {% set user_role = (raw_role|string)|lower %}
      {% endif %}
      {# Fallback: if username is admin but role missing, treat as admin #}
      {% if (not user_role) and session.get('username') == 'admin' %}
        {% set user_role = 'admin' %}
      {% endif %}

      <div class="collapse navbar-collapse" id="navbarNav">
        <!-- Left Links -->
        <ul class="navbar-nav ms-5 me-auto mb-2 mb-lg-0 gap-4">
          {% if session.get('logged_in') %}
            {% if user_role == 'admin' %}
              <li class="nav-item">
                <a class="nav-link {% if 'dashboard_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('dashboard_bp.dashboard') }}">
                  <i class="bi bi-speedometer2 me-1"></i>Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if 'reports_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('reports_bp.reports_page') }}">
                  <i class="bi bi-table me-1"></i>Reports
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if 'admin_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('admin_bp.admin_settings') }}">
                  <i class="bi bi-gear me-1"></i>Settings
                </a>
              </li>

              <!-- Admin: Toggle View as different dashboards -->
              <li class="nav-item dropdown">
                <button class="nav-link dropdown-toggle btn btn-link p-0 border-0 text-decoration-none"
                        id="toggleViewDropdown"
                        data-bs-toggle="dropdown"
                        type="button">
                  <i class="bi bi-eye me-1"></i>Toggle View
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="toggleViewDropdown" style="min-width: 280px; max-height: 500px; overflow-y: auto;">
                  <!-- Explore Sections -->
                  <li class="dropdown-header">Explore Sections</li>
                  <li>
                    <button class="dropdown-item class-explorer-link" type="button"
                            onclick="window.location='{{ url_for('teacher_dashboard_bp.class_explorer') }}'">
                      <i class="bi bi-search me-2"></i>Class Explorer
                    </button>
                  </li>
                  <li>
                    <button class="dropdown-item department-explorer-link" type="button"
                            onclick="window.location='{{ url_for('hod_dashboard_bp.department_explorer') }}'">
                      <i class="bi bi-building me-2"></i>Department Explorer
                    </button>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Quick Class Access -->
                  <li class="dropdown-header">Quick Class Access</li>
                  <li>
                    <button class="dropdown-item" type="button"
                            onclick="window.location='{{ url_for('teacher_dashboard_bp.dashboard', class_name='5 B M') }}'">
                      <i class="bi bi-graduation-cap me-2"></i>Class 5 B M
                    </button>
                  </li>
                  <li>
                    <button class="dropdown-item" type="button"
                            onclick="window.location='{{ url_for('teacher_dashboard_bp.dashboard', class_name='1 A F') }}'">
                      <i class="bi bi-graduation-cap me-2"></i>Class 1 A F
                    </button>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Quick Department Access -->
                  <li class="dropdown-header">Quick Department Access</li>
                  <li>
                    <button class="dropdown-item department-item" type="button"
                            onclick="window.location='{{ url_for('hod_dashboard_bp.dashboard', dept='S-CO') }}'">
                      <div>
                        <div class="department-code">S-CO</div>
                        <div class="department-name">Collegiate I (5-7)</div>
                      </div>
                    </button>
                  </li>
                  <li>
                    <button class="dropdown-item department-item" type="button"
                            onclick="window.location='{{ url_for('hod_dashboard_bp.dashboard', dept='S-CT') }}'">
                      <div>
                        <div class="department-code">S-CT</div>
                        <div class="department-name">Collegiate II & Higher Studies (Std 8-11)</div>
                      </div>
                    </button>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Custom Class Entry -->
                  <li class="dropdown-header">Custom Class</li>
                  <div class="px-3 py-2">
                    <form class="quick-class-form" action="{{ url_for('teacher_dashboard_bp.dashboard') }}" method="get">
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" name="class_name" placeholder="Enter class (e.g., 5 B M)" required>
                        <button class="btn btn-primary btn-sm" type="submit">
                          <i class="bi bi-arrow-right"></i>
                        </button>
                      </div>
                    </form>
                  </div>
                  
                  <!-- Custom Department Entry -->
                  <li class="dropdown-header">Custom Department</li>
                  <div class="px-3 py-2">
                    <form class="quick-dept-form" action="{{ url_for('hod_dashboard_bp.dashboard') }}" method="get">
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" name="dept" placeholder="Enter department code" required>
                        <button class="btn btn-primary btn-sm" type="submit">
                          <i class="bi bi-arrow-right"></i>
                        </button>
                      </div>
                    </form>
                  </div>
                </ul>
              </li>

            {% elif user_role == 'hod' %}
              <li class="nav-item">
                <a class="nav-link {% if 'hod_dashboard_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('hod_dashboard_bp.dashboard') }}">
                  <i class="bi bi-building me-1"></i>My Department
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link {% if 'reports_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('reports_bp.reports_page') }}">
                  <i class="bi bi-graph-up me-1"></i>Reports
                </a>
              </li>

            {% elif user_role == 'teacher' %}
              <li class="nav-item">
                <a class="nav-link {% if 'teacher_dashboard_bp' in request.blueprint %}active{% endif %}"
                   href="{{ url_for('teacher_dashboard_bp.dashboard') }}">
                  <i class="bi bi-people me-1"></i>My Class
                </a>
              </li>
            {% endif %}
          {% endif %}
        </ul>

        <!-- Right Links -->
        <ul class="navbar-nav align-items-center gap-3">
          {% if session.get('logged_in') %}
            <!-- Notifications -->
            <li class="nav-item position-relative">
              <a href="#" class="nav-link position-relative" title="Notifications" data-bs-toggle="dropdown">
                <i class="bi bi-bell fs-5"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notification-badge">3</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end shadow" id="notification-dropdown" style="min-width: 250px;">
                <li class="dropdown-header">Notifications</li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-book me-2"></i>New library books added</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-clock-history me-2"></i>You have overdue books</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-calendar-event me-2"></i>Department meeting tomorrow</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-exclamation-triangle me-2"></i>System maintenance scheduled</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-center" href="#"><i class="bi bi-list me-1"></i>View all notifications</a></li>
              </ul>
            </li>
            
            <!-- Theme Toggle -->
            <li class="nav-item">
              <button class="btn btn-sm btn-outline-light" id="themeToggle" title="Toggle theme">
                <i class="bi bi-brightness-high"></i>
              </button>
            </li>
            
            <!-- Profile Dropdown with avatar -->
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                {% set nav_pic = session.get('profile_picture', 'images/avatar.png') %}
                <img src="{{ url_for('static', filename=nav_pic) }}"
                     alt="Profile"
                     class="nav-profile-avatar me-1">
                <span>{{ session.get('username', 'User') }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end shadow" style="min-width: 200px;">
                <li class="dropdown-header text-center">
                  <strong>{{ session.get('username', 'User') }}</strong><br>
                  <small class="text-muted text-capitalize">{{ user_role or 'guest' }}</small>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile_bp.view_profile') }}">
                    <i class="bi bi-person me-2"></i>View Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile_bp.edit_profile') }}">
                    <i class="bi bi-pencil-square me-2"></i>Edit Profile
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('profile_bp.change_password') }}">
                    <i class="bi bi-lock me-2"></i>Change Password
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item text-danger" href="{{ url_for('auth_bp.logout') }}">
                    <i class="bi bi-box-arrow-right me-2"></i>Logout
                  </a>
                </li>
              </ul>
            </li>
          {% else %}
            <li class="nav-item">
              <a class="btn btn-outline-light btn-sm" href="{{ url_for('auth_bp.login') }}">
                <i class="bi bi-person-lock me-1"></i>Login
              </a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>
  {% endif %}

  <main class="container mt-4 flex-grow-1 mb-5">
    {% block content %}{% endblock %}
  </main>

  {% if not hide_nav %}
  <footer class="mt-auto border-top py-2">
    <div class="container d-flex flex-wrap justify-content-between align-items-center small">
      <div>
        <strong>ðŸ“š Aljamea-tus-Saifiyah â€“ Library</strong> â€¢ <span id="currentYear"></span> Â© All rights reserved
      </div>
      <div class="text-muted d-none d-sm-inline" id="currentDateTime"></div>
      <div>
        <a href="{{ url_for('static', filename='docs/about.pdf') }}" target="_blank">
          <i class="bi bi-info-circle me-1"></i>About
        </a> &nbsp;|&nbsp;
        <a href="{{ url_for('static', filename='docs/help.pdf') }}" target="_blank">
          <i class="bi bi-question-circle me-1"></i>Help
        </a> &nbsp;|&nbsp;
        <a href="mailto:library@ajsn.co.ke">
          <i class="bi bi-envelope me-1"></i>Contact
        </a>
        <span class="text-muted ms-3">v2.0.0</span>
      </div>
    </div>
  </footer>
  {% endif %}

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js" defer></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js" defer></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/script.js') }}" defer></script>

  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      // Set current year in footer
      const yearEl = document.getElementById('currentYear');
      if (yearEl) yearEl.textContent = new Date().getFullYear();

      // Live date-time in footer
      const dtEl = document.getElementById('currentDateTime');
      if (dtEl) {
        const fmt = new Intl.DateTimeFormat(undefined, {
          weekday: 'short', 
          year: 'numeric', 
          month: 'short', 
          day: '2-digit',
          hour: '2-digit', 
          minute: '2-digit'
        });
        const tick = () => { 
          dtEl.textContent = fmt.format(new Date()); 
        };
        tick(); 
        setInterval(tick, 60000); // Update every minute
      }

      // Theme toggle functionality
      const toggleBtn = document.getElementById('themeToggle');
      if (toggleBtn) {
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
          document.body.classList.add('bg-dark', 'text-light');
          toggleBtn.innerHTML = '<i class="bi bi-moon"></i>';
        }
        
        toggleBtn.addEventListener('click', () => {
          const isDark = document.body.classList.toggle('bg-dark');
          document.body.classList.toggle('text-light');
          
          // Save preference
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
          
          // Update icon
          toggleBtn.innerHTML = isDark ? 
            '<i class="bi bi-moon"></i>' : 
            '<i class="bi bi-brightness-high"></i>';
        });
      }

      // Quick form submissions
      document.querySelectorAll('.quick-class-form').forEach(form => {
        form.addEventListener('submit', function(e) {
          const classInput = this.querySelector('input[name="class_name"]');
          if (!classInput.value.trim()) {
            e.preventDefault();
            classInput.focus();
            classInput.classList.add('is-invalid');
            return false;
          }
        });
      });

      document.querySelectorAll('.quick-dept-form').forEach(form => {
        form.addEventListener('submit', function(e) {
          const deptInput = this.querySelector('input[name="dept"]');
          if (!deptInput.value.trim()) {
            e.preventDefault();
            deptInput.focus();
            deptInput.classList.add('is-invalid');
            return false;
          }
        });
      });

      // Notification badge update
      function updateNotificationBadge() {
        const badge = document.getElementById('notification-badge');
        if (badge) {
          // This is a placeholder - in production, fetch actual count
          // const count = Math.floor(Math.random() * 5); // Example random count
          // badge.textContent = count > 0 ? count : '';
          // badge.style.display = count > 0 ? 'inline-block' : 'none';
        }
      }
      
      updateNotificationBadge();

      // Auto-close dropdowns on mobile after click
      if (window.innerWidth < 768) {
        document.querySelectorAll('.dropdown-menu a, .dropdown-menu button').forEach(item => {
          item.addEventListener('click', () => {
            const dropdown = item.closest('.dropdown');
            if (dropdown) {
              const toggle = dropdown.querySelector('.dropdown-toggle');
              if (toggle) {
                toggle.click(); // Close dropdown
              }
            }
          });
        });
      }

      // Add active class to current page link
      const currentPath = window.location.pathname;
      document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        const linkPath = link.getAttribute('href');
        if (linkPath && currentPath.includes(linkPath.replace(/^\/+/, '').split('?')[0])) {
          link.classList.add('active');
        }
      });

    });
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>