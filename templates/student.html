{% extends "base.html" %}

{% block content %}
{% if not found %}
  <div class="alert alert-warning">{{ message }}</div>
{% else %}

  <style>
    /* Bigger, more readable metric badges */
    .badge-metric {
      font-size: 0.95rem;
      padding: 0.45rem 0.75rem;
      font-weight: 500;
    }

    /* Purple badge for MustawƒÅ al-Ma·π≠l≈´b */
    .badge-mustawa {
      background-color: #6f42c1;
      color: #fff;
    }

    /* Alkanz font for Arabic titles */
    .arabic-text {
      font-family: 'Alkanz', sans-serif;
      text-align: center;
    }
  </style>

  <!-- Main Heading -->
  <div class="mb-4">
    <h3 class="text-primary">üìö Library Report</h3>
    <h5 class="text-secondary">
      {{ info.FullName or info.cardnumber or "Unnamed Student" }}
    </h5>
    {% set m = info["Metrics"] %}
    <p class="text-muted small mb-0">
      Academic Year: <strong>{{ m["AYPeriodLabel"] }}</strong>
    </p>
  </div>

  <div class="row mb-4">
    <!-- Student Photo -->
    <div class="col-md-3 text-center">
      <img src="{{ url_for('static', filename=info.Photo) }}"
           class="img-fluid rounded-circle border shadow-sm"
           alt="{{ info.FullName or 'Student Photo' }}"
           style="max-height:180px;">
    </div>

    <!-- Student Details -->
    <div class="col-md-9">
      <div class="card">
        <div class="card-header bg-primary text-white">Student Details</div>
        <div class="card-body p-2">
          <table class="table table-bordered table-sm mb-0">
            <!-- Borrower Number / Card Number removed as requested -->
            <tr><th>Full Name</th><td>{{ info.FullName or "N/A" }}</td></tr>
            <tr><th>Edu Email</th><td>{{ info.EduEmail or "N/A" }}</td></tr>
            <tr><th>ITS ID</th><td>{{ info["ITS ID"] or "N/A" }}</td></tr>
            <tr><th>Class</th><td>{{ info["Class"] or "N/A" }}</td></tr>
            <tr><th>TR Number</th><td>{{ info["TRNumber"] or "N/A" }}</td></tr>
            <tr><th>Department</th><td>{{ info["Department"] or "N/A" }}</td></tr>
            <tr><th>Class Teacher</th><td>{{ info["ClassTeacher"] or "N/A" }}</td></tr>
          </table>
        </div>
      </div>

      <!-- Engagement Metrics -->
      <div class="card mt-3">
        <div class="card-header bg-light">üìà Engagement Metrics</div>
        <div class="card-body p-2">
          {% set m = info["Metrics"] %}
          <div class="row g-2">
            <div class="col-6 col-lg-4">
              <span class="badge bg-secondary w-100 badge-metric">
                Lifetime Issues: {{ m["LifetimeIssues"] }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-secondary w-100 badge-metric">
                AY Issues: {{ m["AYIssues"] }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-secondary w-100 badge-metric">
                Active Loans: {{ m["ActiveLoans"] }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-danger w-100 badge-metric">
                Overdue Now: {{ m["OverdueNow"] }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-info text-dark w-100 badge-metric">
                Reservations: {{ m["Reservations"] }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-warning text-dark w-100 badge-metric">
                Outstanding: {{ m["OutstandingBalance"] | float }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-success w-100 badge-metric">
                Fines Paid (Total): {{ m["TotalFinesPaid"] | float }}
              </span>
            </div>
            <div class="col-6 col-lg-4">
              <span class="badge bg-success w-100 badge-metric">
                Fines Paid (AY): {{ m["FinesPaidAY"] | float }}
              </span>
            </div>
            <!-- Favourite Authors dropdown -->
            <div class="col-12 mt-2">
              {% if m["FavoriteAuthors"] %}
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                          type="button"
                          id="favAuthorsDropdown"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                    Favorite Authors (last 12 months)
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="favAuthorsDropdown">
                    {% for a in m["FavoriteAuthors"] %}
                      <li><a class="dropdown-item small" href="{{ OPAC_BASE }}/author/{{ a|urlencode }}" target="_blank">{{ a }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <small class="text-muted">
                  Favorite Authors (last 12 months): -
                </small>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Borrowed Books Accordion -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white">üìö Borrowed Books (Academic Year)</div>
    <div class="card-body p-2">
      {% if info["BorrowedBooksGrouped"] %}
        <div class="accordion" id="borrowedBooksAccordion">
          {% for month, books in info["BorrowedBooksGrouped"] %}
          {% set ms = info["MonthStats"].get(month) if info["MonthStats"] else None %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
              <button class="accordion-button {{ 'collapsed' if not loop.first }}"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#collapse{{ loop.index }}"
                      aria-expanded="{{ 'true' if loop.first else 'false' }}"
                      aria-controls="collapse{{ loop.index }}">
                üìÖ {{ month }} ({{ books|length }} books)

                {% if ms and ms.target %}
                  <!-- Status vs MustawƒÅ al-Ma·π≠l≈´b -->
                  <span class="ms-2 badge badge-metric
                              {% if ms.reco_status == 'meets' %}bg-success
                              {% elif ms.reco_status == 'below' %}bg-danger
                              {% else %}bg-secondary{% endif %}">
                    {{ ms.count }} / {{ ms.target }} books this month
                  </span>

                  <!-- Mustawa badge -->
                  <span class="ms-2 badge badge-metric badge-mustawa">
                    MustawƒÅ al-Ma·π≠l≈´b: {{ ms.target }} books Monthly
                  </span>
                {% elif ms %}
                  <!-- Fallback if no target configured -->
                  <span class="ms-2 badge badge-metric bg-secondary">
                    {{ ms.count }} books this month
                  </span>
                {% endif %}
              </button>
            </h2>
            <div id="collapse{{ loop.index }}"
                 class="accordion-collapse collapse {{ 'show' if loop.first else '' }}"
                 aria-labelledby="heading{{ loop.index }}"
                 data-bs-parent="#borrowedBooksAccordion">
              <div class="accordion-body">

                {% if ms %}
                  <div class="alert alert-
                       {% if ms.reco_status == 'meets' %}success
                       {% elif ms.reco_status == 'below' %}warning
                       {% else %}secondary{% endif %}
                       mb-2 py-2 small">
                    {{ ms.reco_text }}
                  </div>
                {% endif %}

                <div class="table-responsive">
                  <table class="table table-striped table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Title </th>
                        <th>Collection</th>
                        <th>Language</th>
                        <th>Date Issued (Hijri)</th>
                        <th>Due Date (Hijri)</th>
                        <th>Returned?</th>
                        <th>Overdue?</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for b in books %}
                      <tr>
                        <td>
                          {% if opac_base_url and b.biblionumber %}
                            <a href="{{ opac_base_url }}/cgi-bin/koha/opac-detail.pl?biblionumber={{ b.biblionumber }}"
                               target="_blank"
                               class="link-primary text-decoration-none">
                              {{ b.title or "N/A" }}
                            </a>
                          {% else %}
                            {{ b.title or "N/A" }}
                          {% endif %}
                        </td>
                        <td>{{ b.collection or "-" }}</td>
                        <td>{{ b.language or "-" }}</td>
                        <td>{{ b._issued_hijri or "N/A" }}</td>
                        <td>{{ b._due_hijri or "N/A" }}</td>
                        <td>
                          {% if b.returned %}
                            <span class="text-success">‚úÖ Yes</span>
                          {% else %}
                            <span class="text-danger">‚ùå No</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if b.overdue %}
                            <span class="badge bg-danger">Overdue</span>
                          {% else %}
                            <span class="badge bg-success">On Time</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">No borrowed books found in this Academic Year.</p>
      {% endif %}
    </div>
  </div>

  <!-- Fines & Payments (AY) -->
  <div class="card mb-3">
    <div class="card-header bg-warning text-dark">üí∞ Fines & Payments (Academic Year)</div>
    <div class="card-body p-2">
      {% if info.get("FinesList") %}
        <div class="table-responsive">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr>
                <th>Date (Hijri)</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              {% for f in info["FinesList"] %}
              <tr>
                <td>{{ f.date or "N/A" }}</td>
                <td>{{ f.amount | float }}</td>
                <td>{{ f.description or "-" }}</td>
                <td>{{ f.note or "-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No fines or payments found for this Academic Year.</p>
      {% endif %}
    </div>
  </div>

  <!-- PDF Download -->
  <div class="mt-3">
    <a id="downloadBtn" class="btn btn-outline-primary"
       href="{{ url_for('students_bp.export_student_pdf', identifier=(info['TRNumber'] or info.cardnumber or info['ITS ID'] or info.borrowernumber)) }}">
       ‚¨áÔ∏è Download PDF
    </a>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const dl = document.getElementById("downloadBtn");
  if (dl && window.showToast) {
    dl.addEventListener("click", function(){
      showToast("Preparing PDF for download...", "info");
    });
  }
});
</script>
{% endblock %}
