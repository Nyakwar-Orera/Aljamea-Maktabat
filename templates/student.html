{% extends "base.html" %}
{% block content %}
{% if not found %}
  <div class="alert alert-warning">{{ message }}</div>
{% else %}
  <!-- Main Heading -->
  <div class="mb-4">
    <h3 class="text-primary">üë©‚Äçüéì Student Report</h3>
    <h5 class="text-secondary">{{ info.FullName or info.cardnumber or "Unnamed Student" }}</h5>
    <div class="mt-2">
      <span class="badge bg-info text-dark me-2">
        Total Issues: {{ info["Total Issues"] | default(0) | int }}
      </span>
      <span class="badge bg-warning text-dark">
        Total Fines Paid: {{ info["Total Fines Paid"] | default(0) | float }}
      </span>
    </div>
  </div>

  <div class="row mb-4">
    <!-- Student Photo -->
    <div class="col-md-3 text-center">
      <img src="{{ url_for('static', filename=info.Photo) }}"
           class="img-fluid rounded-circle border shadow-sm"
           alt="{{ info.FullName or 'Student Photo' }}"
           style="max-height:180px;">
    </div>

    <!-- Student Details -->
    <div class="col-md-9">
      <div class="card">
        <div class="card-header bg-primary text-white">Student Details</div>
        <div class="card-body p-2">
          <table class="table table-bordered table-sm mb-0">
            <tr><th>Borrower Number</th><td>{{ info.borrowernumber or "N/A" }}</td></tr>
            <tr><th>Card Number</th><td>{{ info.cardnumber }}</td></tr>
            <tr><th>Full Name</th><td>{{ info.FullName or "N/A" }}</td></tr>
            <tr><th>Edu Email</th><td>{{ info.EduEmail or "N/A" }}</td></tr>
            <tr><th>ITS ID</th><td>{{ info["ITS ID"] or "N/A" }}</td></tr>
            <tr><th>Class</th><td>{{ info["Class"] or "N/A" }}</td></tr>
            <tr><th>TR Number</th><td>{{ info["TRNumber"] or "N/A" }}</td></tr>
            <tr><th>Department</th><td>{{ info["Department"] or "N/A" }}</td></tr>
            <tr><th>Class Teacher</th><td>{{ info["ClassTeacher"] or "N/A" }}</td></tr>
          </table>
        </div>
      </div>

      <!-- Engagement Metrics -->
      <div class="card mt-3">
        <div class="card-header bg-light">üìà Engagement Metrics</div>
        <div class="card-body p-2">
          {% set m = info["Metrics"] %}
          <div class="row g-2">
            <div class="col-6 col-lg-4"><span class="badge bg-secondary w-100">Lifetime: {{ m["LifetimeIssues"] }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-secondary w-100">AY Issues: {{ m["AYIssues"] }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-secondary w-100">Active Loans: {{ m["ActiveLoans"] }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-danger w-100">Overdue Now: {{ m["OverdueNow"] }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-info text-dark w-100">Reservations: {{ m["Reservations"] }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-warning text-dark w-100">Outstanding: {{ m["OutstandingBalance"] | float }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-success w-100">Fines Paid: {{ m["TotalFinesPaid"] | float }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-success w-100">Fines Paid (AY): {{ m["FinesPaidAY"] | float }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-light text-dark w-100">Last Issue: {{ m["LastIssueDate"] or "-" }}</span></div>
            <div class="col-6 col-lg-4"><span class="badge bg-light text-dark w-100">Last Return: {{ m["LastReturnDate"] or "-" }}</span></div>
            <div class="col-12">
              {% if m["FavoriteAuthors"] %}
                <small class="text-muted">Favorite Authors (12m): {{ m["FavoriteAuthors"]|join(", ") }}</small>
              {% else %}
                <small class="text-muted">Favorite Authors (12m): -</small>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Summary Badges -->
      <div class="mt-3">
        <span class="badge bg-success me-2">
          üìö Currently Borrowed:
          {{ info["BorrowedBooks"] | selectattr("returned", "equalto", False) | list | length }}
        </span>
        <span class="badge bg-danger me-2">
          ‚è∞ Overdue: {{ info["Overdue Count"] }}
        </span>
        <span class="badge bg-secondary">
          üí∞ Fines Paid: {{ info["Total Fines Paid"] | default(0) | float }}
        </span>
      </div>
    </div>
  </div>

  <!-- Borrowed Books Accordion -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white">üìö Borrowed Books</div>
    <div class="card-body p-2">
      {% if info["BorrowedBooksGrouped"] %}
        <div class="accordion" id="borrowedBooksAccordion">
          {% for month, books in info["BorrowedBooksGrouped"] %}
          <div class="accordion-item">
            <h2 class="accordion-header" id="heading{{ loop.index }}">
              <button class="accordion-button {{ 'collapsed' if not loop.first }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{{ 'true' if loop.first else 'false' }}" aria-controls="collapse{{ loop.index }}">
                üìÖ {{ month }} ({{ books|length }} books)
              </button>
            </h2>
            <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {{ 'show' if loop.first else '' }}" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#borrowedBooksAccordion">
              <div class="accordion-body">
                <div class="table-responsive">
                  <table class="table table-striped table-sm mb-0">
                    <thead>
                      <tr>
                        <th>Title</th>
                        <th>Date Issued</th>
                        <th>Due Date</th>
                        <th>Returned?</th>
                        <th>Overdue?</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for b in books %}
                      <tr>
                        <td>{{ b.title or "N/A" }}</td>
                        <td>{{ b.date_issued or "N/A" }}</td>
                        <td>{{ b.date_due or "N/A" }}</td>
                        <td>
                          {% if b.returned %}
                            <span class="text-success">‚úÖ Yes</span>
                          {% else %}
                            <span class="text-danger">‚ùå No</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if b.overdue %}
                            <span class="badge bg-danger">Overdue</span>
                          {% else %}
                            <span class="badge bg-success">On Time</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted mb-0">No borrowed books found.</p>
      {% endif %}
    </div>
  </div>

  <!-- Fines & Payments -->
  <div class="card mb-3">
    <div class="card-header bg-warning text-dark">üí∞ Fines & Payments</div>
    <div class="card-body p-2">
      {% if info.get("FinesList") %}
        <div class="table-responsive">
          <table class="table table-striped table-sm mb-0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Amount</th>
                <th>Description</th>
                <th>Note</th>
              </tr>
            </thead>
            <tbody>
              {% for f in info["FinesList"] %}
              <tr>
                <td>{{ f.date or "N/A" }}</td>
                <td>{{ f.amount | float }}</td>
                <td>{{ f.description or "-" }}</td>
                <td>{{ f.note or "-" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No fines or payments found.</p>
      {% endif %}
    </div>
  </div>

  <!-- PDF Download -->
  <div class="mt-3">
    <a id="downloadBtn" class="btn btn-outline-primary"
       href="{{ url_for('students_bp.export_student_pdf', identifier=(info['TRNumber'] or info.cardnumber or info['ITS ID'] or info.borrowernumber)) }}">
       ‚¨áÔ∏è Download PDF
    </a>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  const dl = document.getElementById("downloadBtn");
  if (dl && window.showToast) {
    dl.addEventListener("click", function(){
      showToast("Preparing PDF for download...", "info");
    });
  }
});
</script>
{% endblock %}
