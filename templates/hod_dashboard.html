{% extends "base.html" %}

{% block content %}
<style>
  body { background-color: #f8f9fa; }
  .card { border-radius: 1rem; border: none; }
  .kpi-card { transition: transform .2s ease; }
  .kpi-card:hover { transform: translateY(-4px); }
  .chart-wrap { height: 300px; position: relative; }
  .table thead { background-color: #0d6efd; color: #fff; }
  .table-hover tbody tr:hover { background: #f3f6ff; }
  .truncate-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
  .chart-empty {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    color: #adb5bd; font-style: italic;
  }
</style>

<div class="container mt-4">
  <h2>üèõ {{ dept_name }} ‚Äî Department Dashboard</h2>
  <p class="text-muted mb-4">Welcome {{ username }}, here‚Äôs your department‚Äôs performance snapshot.</p>

  <!-- Search -->
  <form action="{{ url_for('hod_dashboard_bp.search') }}" method="get" class="mb-4">
    <div class="input-group shadow-sm">
      <input type="text" name="q" class="form-control" placeholder="üîé Search student name, TR number, or class‚Ä¶" required>
      <button class="btn btn-primary" type="submit">Search</button>
    </div>
  </form>

  <!-- Department KPIs -->
<div class="row g-3 mb-4">
  {% set kpis = [
    {'label':'Borrowers','value':total_borrowers,'icon':'bi-people','color':'primary'},
    {'label':'Issues (AY)','value':total_issues,'icon':'bi-graph-up-arrow','color':'success'},
    {'label':'Fines Paid','value':"%.2f"|format(total_fines),'icon':'bi-cash-stack','color':'warning'},
    {'label':'Active Loans','value':active_loans,'icon':'bi-book','color':'info'},
    {'label':'Overdues','value':overdues,'icon':'bi-alarm','color':'danger'}
  ] %}
  {% for k in kpis %}
  <div class="col-6 col-sm-4 col-md-3 col-lg-2">
    <div class="card shadow-sm border-0 h-100 text-center py-3 px-2">
      <div class="card-body">
        <div class="mb-2">
          <span class="rounded-circle d-inline-flex align-items-center justify-content-center bg-{{ k.color }} bg-opacity-10 p-3">
            <i class="bi {{ k.icon }} text-{{ k.color }} fs-3"></i>
          </span>
        </div>
        <div class="fw-semibold text-secondary small">{{ k.label }}</div>
        <div class="fw-bold fs-5 text-{{ k.color }}">{{ k.value }}</div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>


  <!-- Daily Trend -->
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">üìÜ Daily Borrowing Trend (This Month)</div>
    <div class="card-body position-relative">
      <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
      {% if trend_values|sum == 0 %}
      <div class="chart-empty">No borrowing activity recorded this month.</div>
      {% endif %}
    </div>
  </div>

  <!-- Class Breakdown + Class KPIs -->
  <div class="row mb-4">
    <div class="col-md-7">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">üè´ Issues by Class (AY)</div>
        <div class="card-body position-relative">
          <div class="chart-wrap"><canvas id="classChart"></canvas></div>
          {% if class_values|sum == 0 %}
          <div class="chart-empty">No issue data available for this academic year.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-5">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">üìä Class-Level KPIs</div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            {% for label, val in zip(class_labels, class_values) %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ label }}
              <span class="badge bg-primary rounded-pill">{{ val }}</span>
            </li>
            {% else %}
            <li class="list-group-item text-muted text-center">No KPI data available</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Titles -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">üìó Top Arabic Titles</div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead><tr><th>#</th><th>Title</th><th>Times Borrowed</th></tr></thead>
            <tbody>
              {% for t in top_arabic %}
              <tr><td>{{ loop.index }}</td><td class="truncate-2">{{ t[0] }}</td><td class="fw-bold">{{ t[1] }}</td></tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">No Arabic data</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">üìò Top Non-Arabic Titles</div>
        <div class="card-body table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead><tr><th>#</th><th>Title</th><th>Times Borrowed</th></tr></thead>
            <tbody>
              {% for t in top_non_arabic %}
              <tr><td>{{ loop.index }}</td><td class="truncate-2">{{ t[0] }}</td><td class="fw-bold">{{ t[1] }}</td></tr>
              {% else %}
              <tr><td colspan="3" class="text-center text-muted">No Non-Arabic data</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Summary -->
  <div class="card shadow-sm mb-5">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-bold">üìã Department Summary (by Class)</span>
      <a href="{{ url_for('hod_dashboard_bp.download_department_pdf') }}" class="btn btn-sm btn-outline-primary">‚¨áÔ∏è Export PDF</a>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Class</th><th>Issues</th><th>Fines Paid</th><th>Active Loans</th><th>Overdues</th><th></th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary_table %}
          {% set cname = row.get('ClassName') or row.get('Class') or row.get('STD') or '‚Äî' %}
          <tr>
            <td class="fw-semibold">{{ cname }}</td>
            <td>{{ row.get('Issues_AY', 0) }}</td>
            <td>{{ "%.2f"|format(row.get('FinesPaid_AY', 0)) }}</td>
            <td>{{ row.get('ActiveLoans', 0) }}</td>
            <td>{{ row.get('Overdues', 0) }}</td>
            <td><a href="{{ url_for('hod_dashboard_bp.download_class_pdf', class_name=cname) }}" class="btn btn-sm btn-outline-secondary">‚¨áÔ∏è</a></td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-center text-muted">No class data available</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // --- Trend Chart ---
  const tCtx = document.getElementById('trendChart');
  if (tCtx) {
    new Chart(tCtx, {
      type: 'line',
      data: {
        labels: {{ trend_labels|tojson }},
        datasets: [{
          label: 'Issues',
          data: {{ trend_values|tojson }},
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }

  // --- Class Chart ---
  const cCtx = document.getElementById('classChart');
  if (cCtx) {
    new Chart(cCtx, {
      type: 'bar',
      data: {
        labels: {{ class_labels|tojson }},
        datasets: [{
          label: 'Issues',
          data: {{ class_values|tojson }},
          backgroundColor: '#198754',
          maxBarThickness: 32
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } },
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
</script>
{% endblock %}
