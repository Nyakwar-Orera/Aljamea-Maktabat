{% extends "base.html" %}
{% block title %}âš™ï¸ Admin Settings - Maktabat al-Jamea{% endblock %}

{% block content %}
<h2 class="mb-1">âš™ï¸ Admin Settings</h2>
<p class="text-muted mb-4">Brand your portal, manage users & departments, configure email automation, and run diagnostics.</p>

<div class="row">
  <!-- Branding & Appearance -->
  <div class="col-md-6">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-primary text-white">ğŸ¨ Branding & Appearance</div>
      <div class="card-body">
        <form id="brandingForm" class="mb-3">
          <input type="text" id="orgName" name="org_name" class="form-control mb-2" placeholder="Organization Name" required>
          <input type="text" id="siteName" name="site_name" class="form-control mb-2" placeholder="Site Name" required>

          <div class="row g-2">
            <div class="col">
              <label class="form-label">Theme Color</label>
              <input type="color" id="themeColor" name="theme_color" class="form-control form-control-color" value="#004080" title="Pick a color">
            </div>
            <div class="col">
              <label class="form-label">Footer Text</label>
              <input type="text" id="footerText" name="footer_text" class="form-control" placeholder="Â© Maktabat al-Jamea">
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100 mt-3">ğŸ’¾ Save Branding</button>
        </form>

        <form id="logoForm" enctype="multipart/form-data">
          <label class="form-label">Logo (PNG/JPG)</label>
          <input type="file" id="logoFile" name="logo_file" class="form-control mb-2" accept=".png,.jpg,.jpeg,.gif,.webp">
          <button type="submit" class="btn btn-outline-primary w-100">â¬†ï¸ Upload Logo</button>
          <div class="text-center mt-2">
            <img id="logoPreview" src="" alt="Logo preview" style="max-height:60px;">
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Management -->
  <div class="col-md-6">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-success text-white">ğŸ‘¤ Manage User Accounts</div>
      <div class="card-body">
        <form id="userForm" class="mb-3">
          <input type="text" id="username" name="username" class="form-control mb-2" placeholder="Username *" required>
          <input type="email" id="email" name="email" class="form-control mb-2" placeholder="Email *" required>

          <div class="input-group mb-2">
            <input type="password" id="password" name="password" class="form-control" placeholder="Password *" required>
            <button class="btn btn-outline-secondary" type="button" id="togglePassword" tabindex="-1">
              <i class="bi bi-eye"></i>
            </button>
          </div>

          <select id="role" name="role" class="form-select mb-2" required>
            <option value="">Select Role *</option>
            <option value="admin">Admin</option>
            <option value="hod">Head of Department</option>
            <option value="teacher">Class Teacher</option>
          </select>

          <input type="text" id="departmentField" name="department_name" class="form-control mb-2 d-none" placeholder="Department Name (HOD only)">
          <input type="text" id="classField" name="class_name" class="form-control mb-2 d-none" placeholder="Class Name (Teacher only)">

          <button type="submit" class="btn btn-success w-100 mb-2">â• Add User</button>
          <button type="button" id="removeUserBtn" class="btn btn-danger w-100">ğŸ—‘ï¸ Remove User</button>
        </form>

        <h6>Existing Users</h6>
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="usersTable">
            <thead>
              <tr><th>Username</th><th>Email</th><th>Role</th><th>Department</th><th>Class</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Email Settings (Schedule) -->
  <div class="col-md-6">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-info text-white">ğŸ“§ Configure Auto Email Reports</div>
      <div class="card-body">
        <form id="emailForm" class="mb-3">
          <input type="email" id="emailSender" name="email_sender" class="form-control mb-3" placeholder="Sender Email (example@domain.com)" required>

          <select id="emailFrequency" name="email_frequency" class="form-select mb-3" required>
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
          </select>

          <div id="weeklyOptions" class="mb-3 d-none">
            <label for="dayOfWeek" class="form-label">Day of Week</label>
            <select id="dayOfWeek" name="day_of_week" class="form-select">
              <option value="mon">Monday</option><option value="tue">Tuesday</option>
              <option value="wed">Wednesday</option><option value="thu">Thursday</option>
              <option value="fri">Friday</option>
            </select>
          </div>

          <div id="monthlyOptions" class="mb-3">
            <label for="dayOfMonth" class="form-label">Day of Month (1â€“28)</label>
            <input type="number" id="dayOfMonth" name="day_of_month" class="form-control" min="1" max="28" value="1">
          </div>

          <div class="row mb-3">
            <div class="col"><input type="number" id="sendHour" name="send_hour" class="form-control" min="0" max="23" value="8"></div>
            <div class="col"><input type="number" id="sendMinute" name="send_minute" class="form-control" min="0" max="59" value="0"></div>
          </div>

          <button type="submit" class="btn btn-info w-100 mb-2">ğŸ’¾ Save Email Settings</button>
        </form>

        <div class="d-flex gap-2">
          <form method="post" action="{{ url_for('admin_bp.run_email_reports_now') }}" class="flex-grow-1">
            <button class="btn btn-outline-primary w-100" type="submit">ğŸš€ Send Email Reports Now</button>
          </form>
          <form id="testEmailForm" class="flex-grow-1">
            <div class="input-group">
              <input type="email" name="to" class="form-control" placeholder="Test email to..." required>
              <button class="btn btn-outline-secondary" type="submit">Send Test</button>
            </div>
          </form>
        </div>

      </div>
    </div>
  </div>

  <!-- Database Settings -->
  <div class="col-md-6">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-warning text-dark">ğŸ—„ï¸ Database Connection Settings</div>
      <div class="card-body">
        <form id="dbForm">
          <input type="text" id="dbHost" name="db_host" class="form-control mb-2" placeholder="Host (e.g., localhost)" required>
          <input type="text" id="dbName" name="db_name" class="form-control mb-2" placeholder="Database Name *" required>
          <input type="text" id="dbUser" name="db_user" class="form-control mb-2" placeholder="DB Username *" required>
          <input type="password" id="dbPass" name="db_pass" class="form-control mb-3" placeholder="Password *" required>
          <button type="submit" class="btn btn-warning w-100">ğŸ’¾ Save DB Settings</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Email Templates -->
  <div class="col-md-12">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-secondary text-white">âœ‰ï¸ Email Templates</div>
      <div class="card-body">
        <form id="templateForm" class="mb-3">
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Template</label>
              <select id="templateKey" name="template_key" class="form-select" required>
                <option value="class_report">Class Report</option>
                <option value="department_report">Department Report</option>
                <option value="account_created">Account Created</option>
              </select>
            </div>
            <div class="col-md-9">
              <label class="form-label">Subject</label>
              <input type="text" id="templateSubject" name="subject" class="form-control" required>
            </div>
          </div>
          <label class="form-label mt-2">HTML Body</label>
          <textarea id="templateHtml" name="html" class="form-control" rows="6" required></textarea>
          <small class="text-muted">
            Available placeholders: <code>{{ "{{ class_name }}" }}</code>,
            <code>{{ "{{ dept }}" }}</code>, <code>{{ "{{ head_name }}" }}</code>,
            <code>{{ "{{ username }}" }}</code>, <code>{{ "{{ role }}" }}</code>,
            <code>{{ "{{ password }}" }}</code>, <code>{{ "{{ login_url }}" }}</code>
          </small>
          <button type="submit" class="btn btn-secondary w-100 mt-2">ğŸ’¾ Save Template</button>
        </form>

        <div class="table-responsive">
          <table class="table table-sm table-striped" id="templatesTable">
            <thead><tr><th>Key</th><th>Subject</th><th>Preview</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Department Heads -->
  <div class="col-md-8">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-dark text-white">ğŸ« Manage Department Heads</div>
      <div class="card-body">
        <form id="deptHeadForm" class="mb-3">
          <input type="text" id="deptName" name="department_name" class="form-control mb-2" placeholder="Department Name *" required>
          <input type="text" id="headName" name="head_name" class="form-control mb-2" placeholder="Head Name">
          <input type="email" id="deptEmail" name="email" class="form-control mb-2" placeholder="Head Email *" required>
          <button type="submit" class="btn btn-dark w-100 mb-2">â• Add Department Head</button>
          <button type="button" id="removeDeptBtn" class="btn btn-danger w-100">ğŸ—‘ï¸ Remove Department Head</button>
        </form>

        <h6>Existing Department Heads</h6>
        <div class="table-responsive">
          <table class="table table-sm table-striped" id="deptTable">
            <thead><tr><th>Department</th><th>Head Name</th><th>Email</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Audit Log -->
  <div class="col-md-4">
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light">ğŸ§¾ Recent Activity (Audit)</div>
      <div class="card-body">
        <div class="table-responsive" style="max-height:300px; overflow:auto;">
          <table class="table table-sm" id="auditTable">
            <thead><tr><th>Time</th><th>Actor</th><th>Action</th><th>Details</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function(){
  // ğŸ‘ï¸ Toggle show/hide password
  const toggleBtn = document.getElementById("togglePassword");
  const passwordField = document.getElementById("password");
  toggleBtn.addEventListener("click", function() {
    const isHidden = passwordField.type === "password";
    passwordField.type = isHidden ? "text" : "password";
    this.innerHTML = isHidden ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
  });

  // Toggle weekly/monthly fields
  const freqSel = document.getElementById("emailFrequency");
  function toggleSched() {
    document.getElementById("weeklyOptions").classList.toggle("d-none", freqSel.value !== "weekly");
    document.getElementById("monthlyOptions").classList.toggle("d-none", freqSel.value !== "monthly");
  }
  freqSel.addEventListener("change", toggleSched);
  toggleSched();

  // Toggle department/class input visibility
  const roleSelect = document.getElementById("role");
  const deptField = document.getElementById("departmentField");
  const classField = document.getElementById("classField");
  roleSelect.addEventListener("change", function() {
    const role = this.value;
    deptField.classList.toggle("d-none", role !== "hod");
    classField.classList.toggle("d-none", role !== "teacher");
  });

  // ---------- Branding ----------
  function loadBranding(){
    fetch("/api/get_site_settings")
      .then(r=>r.json())
      .then(s=>{
        document.getElementById("orgName").value = s.org_name || "";
        document.getElementById("siteName").value = s.site_name || "";
        document.getElementById("themeColor").value = s.theme_color || "#004080";
        document.getElementById("footerText").value = s.footer_text || "";
        if(s.logo_path){
          document.getElementById("logoPreview").src = `/static/${s.logo_path}`;
        }
      });
  }
  loadBranding();

  document.getElementById("brandingForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/save_site_settings", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>showToast(j.success ? "âœ… Branding saved" : "âŒ Failed to save branding", j.success?"success":"danger"));
  });

  document.getElementById("logoForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/upload_logo", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>{
        showToast(j.success ? "âœ… Logo uploaded" : (j.error || "âŒ Failed to upload"), j.success?"success":"danger");
        if(j.success && j.logo_path){
          document.getElementById("logoPreview").src = `/static/${j.logo_path}`;
        }
      });
  });

  // ---------- USERS ----------
  function loadUsers(){
    fetch("/api/list_users").then(r=>r.json()).then(data=>{
      const tbody=document.querySelector("#usersTable tbody"); tbody.innerHTML="";
      data.forEach(u=>{
        tbody.innerHTML+=`<tr>
          <td>${u.username}</td><td>${u.email}</td><td>${u.role}</td>
          <td>${u.department_name || "-"}</td><td>${u.class_name || "-"}</td>
        </tr>`;
      });
    });
  }
  loadUsers();

  document.getElementById("userForm").addEventListener("submit", function(e){
    e.preventDefault();

    const form = this;
    const fd = new FormData(form);

    fetch("/api/add_user", { method: "POST", body: fd })
      .then(r => r.json())
      .then(j => {
        const username = document.getElementById("username").value || "user";

        let msg;
        let type;

        if (j.success) {
          msg = j.message || `âœ… User '${username}' has been registered successfully.`;
          type = "success";
        } else {
          msg = j.error || "âŒ We could not complete this registration. Please try again.";
          type = "danger";
        }

        if (window.showToast) {
          showToast(msg, type);
        } else {
          alert(msg);
        }

        if (j.success) {
          form.reset();
          deptField.classList.add("d-none");
          classField.classList.add("d-none");
          loadUsers();
        }
      })
      .catch(err => {
        console.error("Add user error:", err);
        if (window.showToast) {
          showToast("âŒ A network error occurred. Please check your connection and try again.", "danger");
        } else {
          alert("A network error occurred.");
        }
      });
  });

  document.getElementById("removeUserBtn").addEventListener("click", function(){
    const username=document.getElementById("username").value;
    if(!username) return showToast("Enter a username to remove", "warning");
    if(!confirm(`Remove user '${username}'?`)) return;
    fetch("/api/remove_user", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username})
    }).then(r=>r.json()).then(j=>{
      showToast(j.success ? `âœ… User ${username} removed` : "âŒ Failed to remove user", j.success?"success":"danger");
      if(j.success) loadUsers();
    });
  });

  // ---------- EMAIL SETTINGS ----------
  document.getElementById("emailForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/save_email_settings", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>showToast(j.success ? "âœ… Email settings saved" : "âŒ Failed to save email settings", j.success?"success":"danger"));
  });

  // Test email
  document.getElementById("testEmailForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/test_email", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>showToast(j.success ? "âœ… Test email sent" : (j.error || "âŒ Test email failed"), j.success?"success":"danger"));
  });

  // ---------- DB SETTINGS ----------
  document.getElementById("dbForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/save_db_settings", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>showToast(j.success ? "âœ… DB settings saved" : "âŒ Failed to save DB settings", j.success?"success":"danger"));
  });

  // ---------- DEPARTMENT HEADS ----------
  function loadDepts(){
    fetch("/api/list_department_heads").then(r=>r.json()).then(data=>{
      const tbody=document.querySelector("#deptTable tbody"); tbody.innerHTML="";
      data.forEach(d=>{
        tbody.innerHTML+=`<tr><td>${d.department_name}</td><td>${d.head_name || ""}</td><td>${d.email}</td></tr>`;
      });
    });
  }
  loadDepts();

  document.getElementById("deptHeadForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/add_department_head", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>{ showToast(j.success ? "âœ… Department head added" : "âŒ Failed to add department head", j.success?"success":"danger"); if(j.success) loadDepts(); });
  });

  document.getElementById("removeDeptBtn").addEventListener("click", function(){
    const dept_name=document.getElementById("deptName").value;
    if(!dept_name) return showToast("Enter department name to remove", "warning");
    if(!confirm(`Remove department head for '${dept_name}'?`)) return;
    fetch("/api/remove_department_head", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body:JSON.stringify({department_name:dept_name})
    }).then(r=>r.json()).then(j=>{
      showToast(j.success ? `âœ… Department head for ${dept_name} removed` : "âŒ Failed to remove department head", j.success?"success":"danger");
      if(j.success) loadDepts();
    });
  });

  // ---------- Email Templates ----------
  function loadTemplates(){
    fetch("/api/get_email_templates").then(r=>r.json()).then(rows=>{
      const tbl=document.querySelector("#templatesTable tbody"); tbl.innerHTML="";
      rows.forEach(t=>{
        tbl.innerHTML+=`<tr>
          <td>${t.template_key}</td>
          <td>${t.subject}</td>
          <td><button class="btn btn-sm btn-outline-secondary" data-key="${t.template_key}" data-subj="${encodeURIComponent(t.subject)}" data-html="${encodeURIComponent(t.html)}">Load</button></td>
        </tr>`;
      });
      tbl.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          document.getElementById("templateKey").value = b.dataset.key;
          document.getElementById("templateSubject").value = decodeURIComponent(b.dataset.subj);
          document.getElementById("templateHtml").value = decodeURIComponent(b.dataset.html);
          showToast("Template loaded into editor", "info");
        });
      });
    });
  }
  loadTemplates();

  document.getElementById("templateForm").addEventListener("submit", function(e){
    e.preventDefault();
    fetch("/api/save_email_template", { method:"POST", body:new FormData(this) })
      .then(r=>r.json())
      .then(j=>{
        showToast(j.success ? "âœ… Template saved" : (j.error || "âŒ Failed to save template"), j.success?"success":"danger");
        if(j.success) loadTemplates();
      });
  });

  // ---------- Audit ----------
  function loadAudit(){
    fetch("/api/list_audit").then(r=>r.json()).then(rows=>{
      const tbody=document.querySelector("#auditTable tbody"); tbody.innerHTML="";
      rows.forEach(a=>{
        tbody.innerHTML+=`<tr><td>${a.ts}</td><td>${a.actor || "-"}</td><td>${a.action}</td><td>${a.details || ""}</td></tr>`;
      });
    });
  }
  loadAudit();
});
</script>
{% endblock %}
