{% extends "base.html" %}
{% block content %}
<h2 class="mb-3">ğŸ“˜ Class Dashboard â€” {{ class_name }}</h2>

<!-- Download full class report -->
<div class="d-flex justify-content-end mb-3">
  <a href="{{ url_for('teacher_dashboard_bp.download_class_pdf') }}" class="btn btn-danger shadow-sm">
    â¬‡ï¸ Download Full Class Report (PDF)
  </a>
</div>

<!-- KPI cards -->
<div class="row text-center g-3 mb-4">
  {% for num, label, color in [
    (total_students, "Students", "info"),
    (total_issues, "Issues", "success"),
    (total_fines, "Fines Paid", "warning"),
    (total_overdues, "Overdues", "danger"),
    (active_loans, "Active Loans", "secondary")] %}
  <div class="col-md-2">
    <div class="card bg-{{ color }} text-white p-3 shadow-sm h-100">
      <h3>{{ "%.2f"|format(num) if color=='warning' else num }}</h3>
      <p class="mb-0">{{ label }}</p>
    </div>
  </div>
  {% endfor %}
</div>

<hr>

<!-- Top students -->
<h4 class="mt-4 mb-3">ğŸ† Top Performing Students</h4>
<div class="table-responsive">
  <table class="table table-striped table-bordered align-middle shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>Rank</th><th>TRNO</th><th>Name</th>
        <th class="text-center">Issues</th><th class="text-center">Fines Paid</th>
      </tr>
    </thead>
    <tbody>
    {% if top_students %}
      {% for s in top_students %}
      <tr>
        <td><span class="badge bg-primary">{{ loop.index }}</span></td>
        <td>{{ s.TRNumber }}</td>
        <td>{{ s.FullName }}</td>
        <td class="text-center">{{ s.Issues_AY or 0 }}</td>
        <td class="text-center">{{ "%.2f"|format(s.FinesPaid_AY or 0) }}</td>
      </tr>
      {% endfor %}
    {% else %}
      <tr><td colspan="5" class="text-center text-muted">No data</td></tr>
    {% endif %}
    </tbody>
  </table>
</div>

<!-- Borrowing trend -->
<h4 class="mt-5 mb-3">ğŸ“ˆ Borrowing Trend â€” {{ current_month }}</h4>
<div class="bg-light border rounded p-3 shadow-sm">
  <canvas id="trendChart" height="120"></canvas>
</div>

<!-- Top Titles -->
<div class="row mt-5 g-4">
  <div class="col-md-6">
    <h4>ğŸ“š Top Arabic Titles</h4>
    <ul class="list-group list-group-flush shadow-sm">
      {% for t in top_arabic or [] %}
      <li class="list-group-item d-flex justify-content-between">
        <span>{{ t[0] }}</span>
        <span class="badge bg-info">{{ t[1] }}</span>
      </li>
      {% else %}
      <li class="list-group-item text-muted">None</li>
      {% endfor %}
    </ul>
  </div>
  <div class="col-md-6">
    <h4>ğŸ“– Top Non-Arabic Titles</h4>
    <ul class="list-group list-group-flush shadow-sm">
      {% for t in top_non_arabic or [] %}
      <li class="list-group-item d-flex justify-content-between">
        <span>{{ t[0] }}</span>
        <span class="badge bg-secondary">{{ t[1] }}</span>
      </li>
      {% else %}
      <li class="list-group-item text-muted">None</li>
      {% endfor %}
    </ul>
  </div>
</div>

<hr class="mt-5">

<!-- All Students -->
<h4 class="mt-4">ğŸ“ All Students in {{ class_name }}</h4>

<!-- ğŸ” Search Form -->
<form method="get" action="{{ url_for('teacher_dashboard_bp.search_student') }}" class="row g-2 mb-3">
  <div class="col-md-8 col-sm-8">
    <input type="text" name="q" class="form-control shadow-sm" placeholder="ğŸ” Search by name or TRNO" autofocus>
  </div>
  <div class="col-md-2 col-sm-4 d-grid">
    <button type="submit" class="btn btn-primary shadow-sm">ğŸ” Search</button>
  </div>
  <div class="col-md-2 col-sm-4 d-grid">
    <a href="{{ url_for('teacher_dashboard_bp.dashboard') }}" class="btn btn-outline-secondary shadow-sm">â†©ï¸ Reset</a>
  </div>
</form>

<!-- Students Table -->
<div class="table-responsive">
  <table class="table table-hover table-sm shadow-sm align-middle">
    <thead class="table-light">
      <tr>
        <th>TRNO</th><th>Name</th><th>Email</th>
        <th>Issues</th><th>Fines Paid</th><th>Report</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students or [] %}
      <tr>
        <td>{{ s.TRNumber }}</td>
        <td>{{ s.FullName }}</td>
        <td>{{ s.EduEmail }}</td>
        <td>{{ s.Issues_AY }}</td>
        <td>{{ "%.2f"|format(s.FinesPaid_AY or 0) }}</td>
        <td>
          <a href="{{ url_for('teacher_dashboard_bp.download_student_pdf', identifier=s.TRNumber) }}"
             class="btn btn-sm btn-outline-primary">â¬‡ï¸ PDF</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6" class="text-center text-muted">No records found</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('trendChart').getContext('2d');
const raw = {{ daily_trend|tojson }};
const labels = raw.map(r => r[0]);
const issueData = raw.map(r => r[1]);
const returnData = raw.map(r => r[2]);

new Chart(ctx, {
  type: 'line',
  data: {
    labels: labels,
    datasets: [
      { label: 'Books Issued', data: issueData, borderColor: 'rgba(54,162,235,1)',
        backgroundColor: 'rgba(54,162,235,0.2)', tension: 0.3, fill: true, borderWidth: 2, pointRadius: 3 },
      { label: 'Books Returned', data: returnData, borderColor: 'rgba(75,192,75,1)',
        backgroundColor: 'rgba(75,192,75,0.2)', tension: 0.3, fill: true, borderWidth: 2, pointRadius: 3 }
    ]
  },
  options: {
    responsive: true,
    scales: {
      y: { beginAtZero: true, title: { display: true, text: 'Count' } },
      x: { title: { display: true, text: 'Day of Month' } }
    },
    plugins: {
      legend: { display: true, position: 'bottom' },
      tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y}` } }
    }
  }
});
</script>
{% endblock %}
