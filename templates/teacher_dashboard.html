{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">

  <!-- Heading + Download button -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      {% if parsed_class.display and parsed_class.display != parsed_class.original %}
        <h2 class="mb-1">üìò {{ parsed_class.display }} ‚Äì Library Report</h2>
      {% else %}
        <h2 class="mb-1">üìò {{ class_name }} ‚Äì Library Report</h2>
      {% endif %}
      <p class="text-muted mb-0">
        Darajah Masool: <strong>{{ darajah_masool_name }}</strong>
        {% if session.get('role') == 'admin' and request.args.get('class') %}
          <span class="badge bg-info ms-2">Admin view</span>
        {% endif %}
      </p>
    </div>

    <div class="text-end">
      <!-- Admin class selector dropdown -->
      {% if is_admin and all_classes %}
      <div class="dropdown d-inline-block me-2">
        <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" 
                data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-exchange-alt me-1"></i> Switch Class
        </button>
        <ul class="dropdown-menu dropdown-menu-end" style="max-height: 300px; overflow-y: auto;">
          {% for class_item in all_classes %}
          <li>
            <a class="dropdown-item {% if class_item.name == class_name %}active{% endif %}" 
               href="{{ url_for('teacher_dashboard_bp.dashboard', class_name=class_item.name) }}">
              {% if class_item.display and class_item.display != class_item.name %}
                {{ class_item.display }}
              {% else %}
                {{ class_item.name }}
              {% endif %}
              <small class="text-muted ms-1">({{ class_item.gender }})</small>
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
      
      <a href="{{ url_for('teacher_dashboard_bp.download_class_pdf') }}"
         class="btn btn-danger shadow-sm">
        <i class="fas fa-download me-1"></i> Classwise Library Report
      </a>
    </div>
  </div>

  <!-- Class info badge -->
  {% if parsed_class %}
  <div class="mb-3">
    {% if parsed_class.year %}
    <span class="badge bg-primary me-2">
      <i class="fas fa-graduation-cap me-1"></i> Year {{ parsed_class.year }}
    </span>
    {% endif %}
    
    {% if parsed_class.section %}
    <span class="badge bg-info me-2">
      <i class="fas fa-layer-group me-1"></i> Section {{ parsed_class.section }}
    </span>
    {% endif %}
    
    {% if parsed_class.gender %}
    <span class="badge {% if parsed_class.gender == 'Boys' %}bg-primary{% elif parsed_class.gender == 'Girls' %}bg-pink{% else %}bg-secondary{% endif %} me-2">
      <i class="fas fa-{% if parsed_class.gender == 'Boys' %}male{% elif parsed_class.gender == 'Girls' %}female{% else %}users{% endif %} me-1"></i>
      {{ parsed_class.gender }}
    </span>
    {% endif %}
    
    {% if parsed_class.is_arabic %}
    <span class="badge bg-warning text-dark">
      <i class="fas fa-language me-1"></i> Arabic Section
    </span>
    {% endif %}
  </div>
  {% endif %}

  <!-- KPI cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card kpi-card kpi-card-blue h-100">
        <div class="card-body">
          <div class="text-muted small">Students in Darajah</div>
          <div class="fs-3 fw-bold">{{ total_students }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card kpi-card kpi-card-green h-100">
        <div class="card-body">
          <div class="text-muted small">Total Books Issued</div>
          <div class="fs-3 fw-bold">{{ books_issued_class }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card kpi-card kpi-card-gold h-100">
        <div class="card-body">
          <div class="text-muted small">Currently Overdue</div>
          <div class="fs-3 fw-bold">{{ total_overdues_current }}</div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card kpi-card kpi-card-teal h-100">
        <div class="card-body">
          <div class="text-muted small">Total Fines Paid</div>
          <div class="fs-4 fw-bold">
            {{ "%.2f"|format(total_fines) }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Trend + Top students -->
  <div class="row g-3 mb-4">

    <!-- Borrowing trend -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="mb-0">üìà Borrowing Trend {{ trend_period_label }}</h5>
        </div>
        <div class="card-body">
          <div style="height: 240px;">
            <canvas id="classTrendChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Top students -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="mb-0">‚≠ê Top 5 Readers</h5>
        </div>
        <div class="card-body">
          {% if top_students %}
            <ol class="list-group list-group-numbered list-group-flush">
              {% for s in top_students %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">
                      <a href="{{ url_for('students_bp.student', identifier=s.TRNumber) }}"
                         class="link-primary text-decoration-none">
                        {{ s.FullName }}
                      </a>
                    </div>
                    <div class="text-muted small">TR {{ s.TRNumber }}</div>
                  </div>

                  <span class="badge bg-success rounded-pill px-3">
                    {{ s.Issues_AY }} books
                  </span>
                </li>
              {% endfor %}
            </ol>
          {% else %}
            <p class="text-muted mb-0">No borrowing data for this academic year.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Top Arabic + English titles -->
  <div class="row g-3 mb-4">

    <!-- Arabic -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="mb-0">üìö Top Arabic Titles</h5>
        </div>
        <div class="card-body">
          {% if top_arabic %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">Title</th>
                    <th class="text-center">Times Issued</th>
                    <th>Collections</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in top_arabic %}
                    <tr>
                      <td class="small text-center">
                        {% if t.Biblio_ID %}
                          <a href="https://library-opac.ajsn.co.ke/cgi-bin/koha/opac-detail.pl?biblionumber={{ t.Biblio_ID }}"
                             target="_blank"
                             class="link-primary text-decoration-none">
                            {{ t.Title|default('Untitled', true) }}
                          </a>
                        {% else %}
                          <a href="https://library-opac.ajsn.co.ke/cgi-bin/koha/opac-search.pl?q=ti%3A{{ t.Title|urlencode|default('', true) }}"
                             target="_blank"
                             class="link-primary text-decoration-none">
                            {{ t.Title|default('Untitled', true) }}
                          </a>
                        {% endif %}
                      </td>
                      <td class="text-center fw-bold">{{ t.Times_Issued|default(0) }}</td>
                      <td class="small text-muted">{{ t.Collections|default('‚Äî') }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">No Arabic titles issued for this class in AY.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- English -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white">
          <h5 class="mb-0">üìö Top English Titles</h5>
        </div>
        <div class="card-body">
          {% if top_english %}
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="text-center">Title</th>
                    <th class="text-center">Times Issued</th>
                    <th>Collections</th>
                  </tr>
                </thead>
                <tbody>
                  {% for t in top_english %}
                    <tr>
                      <td class="small text-center">
                        {% if t.Biblio_ID %}
                          <a href="https://library-opac.ajsn.co.ke/cgi-bin/koha/opac-detail.pl?biblionumber={{ t.Biblio_ID }}"
                             target="_blank"
                             class="link-primary text-decoration-none">
                            {{ t.Title|default('Untitled', true) }}
                          </a>
                        {% else %}
                          <a href="https://library-opac.ajsn.co.ke/cgi-bin/koha/opac-search.pl?q=ti%3A{{ t.Title|urlencode|default('', true) }}"
                             target="_blank"
                             class="link-primary text-decoration-none">
                            {{ t.Title|default('Untitled', true) }}
                          </a>
                        {% endif %}
                      </td>
                      <td class="text-center fw-bold">{{ t.Times_Issued|default(0) }}</td>
                      <td class="small text-muted">{{ t.Collections|default('‚Äî') }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-0">No English titles issued for this class in AY.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Current month issued -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Currently Issued</h5>
      <span class="text-muted small">
        Month: {{ current_month_label }} ‚Ä¢ Academic Year: {{ ay_period_label }}
      </span>
    </div>

    <div class="card-body">
      {% if month_students %}
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>TR No</th>
                <th>Name</th>
                <th class="text-center">Counter</th>
                <th>Currently Issued Titles</th>
                <th>Collections</th>
                <th class="text-center">Overdue</th>
              </tr>
            </thead>
            <tbody>
              {% for s in month_students %}
                <tr>
                  <td><span class="badge bg-secondary">{{ s.TRNumber|default('‚Äî') }}</span></td>

                  <td>
                    {% if s.TRNumber %}
                      <a href="{{ url_for('students_bp.student', identifier=s.TRNumber) }}"
                         class="link-primary text-decoration-none">
                        {{ s.FullName|default('Name not available') }}
                      </a>
                    {% else %}
                      <span class="text-muted">{{ s.FullName|default('Name not available') }}</span>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    <span class="badge bg-success-subtle text-success-emphasis px-3">
                      {{ s.Books_CurrentMonth|default(0) }}
                    </span>
                  </td>

                  <td class="small">
                    {% if s.Titles_CurrentMonth %}
                      {% set titles = s.Titles_CurrentMonth.split(' ‚Ä¢ ') %}
                      {% for t in titles %}
                        {% if t and t|trim %}
                          <a href="https://library-opac.ajsn.co.ke/cgi-bin/koha/opac-search.pl?q=ti%3A{{ t|urlencode }}"
                             target="_blank"
                             class="link-secondary text-decoration-none">
                            {{ t }}
                          </a>{% if not loop.last %}<span class="text-muted"> ‚Ä¢ </span>{% endif %}
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>

                  <td class="small text-muted">{{ s.Collections_CurrentMonth|default('‚Äî') }}</td>
                  <td class="text-center">{{ s.Overdues_Current|default(0) }}</td>

                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if collections_summary %}
          <p class="mt-3 mb-0 text-muted small">
            <strong>Collections used this month:</strong>
            {{ collections_summary|default('None') }}
          </p>
        {% endif %}

      {% else %}
        <p class="text-muted mb-0">No issues recorded for this class in {{ current_month_label }}.</p>
      {% endif %}
    </div>
  </div>

  <!-- Full student list -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">üë©‚Äçüéì Students Summary ({{ ay_period_label }})</h5>

      <!-- Search form -->
      <form class="d-flex" method="get" action="{{ url_for('teacher_dashboard_bp.search_student') }}">
        {% if session.get('role') == 'admin' and request.args.get('class') %}
          <input type="hidden" name="class" value="{{ request.args.get('class') }}">
        {% endif %}
        <input type="text" name="q" class="form-control form-control-sm me-2"
               placeholder="Search by name or TR No" required>
        <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
      </form>
    </div>

    <div class="card-body">
      {% if students %}
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>TR No</th>
                <th>Student</th>
                <th class="text-center">Books Issued</th>
                <th class="text-center">Overdues</th>
                <th class="text-center">Fines Paid</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>

            <tbody>
              {% for s in students %}
                <tr>
                  <td><span class="badge bg-secondary">{{ s.TRNumber|default('‚Äî') }}</span></td>

                  <td>
                    {% if s.TRNumber %}
                      <a href="{{ url_for('students_bp.student', identifier=s.TRNumber) }}"
                         class="link-primary text-decoration-none">
                        {{ s.FullName|default('Name not available') }}
                      </a>
                    {% else %}
                      <span class="text-muted">{{ s.FullName|default('Name not available') }}</span>
                    {% endif %}
                  </td>

                  <td class="text-center fw-bold">{{ s.Issues_AY|default(0) }}</td>
                  <td class="text-center">{{ s.Overdues|default(0) }}</td>
                  <td class="text-center">{{ "%.2f"|format(s.FinesPaid_AY|default(0.0)) }}</td>
                  <td class="text-center">
                    {% if s.TRNumber %}
                      <a href="{{ url_for('teacher_dashboard_bp.download_report', scope='student:' ~ s.TRNumber, fmt='pdf') }}"
                         class="btn btn-sm btn-outline-danger" title="Download PDF">
                        <i class="fas fa-download"></i>
                      </a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>
      {% else %}
        <p class="text-muted mb-0">No student data available for this class.</p>
      {% endif %}
    </div>
  </div>

</div>

<!-- Chart -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const ctx = document.getElementById("classTrendChart");
  if (!ctx) return;

  const labels = {{ trend_labels|tojson }};
  const values = {{ trend_values|tojson }};

  if (!labels.length || !values.length) {
    // Display a message if no data
    ctx.parentElement.innerHTML = '<p class="text-muted text-center mt-4">No trend data available for this period.</p>';
    return;
  }

  const maxVal = Math.max(...values);

  const pointColors = values.map(v =>
    v === maxVal ? "#d63384" : "#a45a26"
  );

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Books Issued (Academic Year)",
        data: values,
        fill: false,
        borderColor: "#a45a26",
        backgroundColor: "rgba(164,90,38,0.15)",
        tension: 0.3,
        pointRadius: 3,
        pointHoverRadius: 6,
        pointBackgroundColor: pointColors,
        pointBorderColor: pointColors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: true } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 },
          title: { display: true, text: "Number of Books" }
        },
        x: {
          title: { display: true, text: "(Academic Year)" }
        }
      }
    }
  });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
  .bg-pink {
    background-color: #e83e8c !important;
  }
  
  .kpi-card {
    border: none;
    border-radius: 12px;
    transition: transform 0.2s;
  }
  
  .kpi-card:hover {
    transform: translateY(-5px);
  }
  
  .kpi-card-blue {
    background: linear-gradient(135deg, #4dabf7 0%, #1c7ed6 100%);
    color: white;
  }
  
  .kpi-card-green {
    background: linear-gradient(135deg, #40c057 0%, #2b8a3e 100%);
    color: white;
  }
  
  .kpi-card-gold {
    background: linear-gradient(135deg, #ffc034 0%, #e67700 100%);
    color: white;
  }
  
  .kpi-card-teal {
    background: linear-gradient(135deg, #20c997 0%, #0ca678 100%);
    color: white;
  }
</style>
{% endblock %}