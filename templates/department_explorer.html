{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h2 mb-2">
        <i class="fas fa-building me-2"></i>
        Department Explorer
      </h1>
      <div class="text-muted">
        <i class="fas fa-calendar-alt me-1"></i>
        {% if hijri_today %}
          Today: <strong>{{ hijri_today }}</strong>
        {% endif %}
        | <strong>{{ total_departments }}</strong> departments available
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <div class="input-group input-group-sm" style="width: 300px;">
        <span class="input-group-text"><i class="fas fa-search"></i></span>
        <input type="text" id="departmentSearch" class="form-control" placeholder="Search departments...">
      </div>
      <a href="{{ url_for('hod_dashboard_bp.dashboard') }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-primary text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-1 opacity-75">Total Departments</h6>
              <h2 class="card-title mb-0 display-6 fw-bold">{{ total_departments }}</h2>
            </div>
            <i class="fas fa-building fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-success text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-1 opacity-75">Academic Departments</h6>
              <h2 class="card-title mb-0 display-6 fw-bold" id="academicDeptCount">0</h2>
            </div>
            <i class="fas fa-graduation-cap fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-info text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-1 opacity-75">Staff Departments</h6>
              <h2 class="card-title mb-0 display-6 fw-bold" id="staffDeptCount">0</h2>
            </div>
            <i class="fas fa-user-tie fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card shadow-sm border-0 bg-warning text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="card-subtitle mb-1 opacity-75">Total Members</h6>
              <h2 class="card-title mb-0 display-6 fw-bold" id="totalMembers">0</h2>
            </div>
            <i class="fas fa-users fa-2x opacity-50"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Grid by Type -->
  {% for dept_type in sorted_types %}
  {% set type_depts = departments_by_type[dept_type] %}
  <div class="card shadow-sm border-0 mb-4 dept-type-section" data-type="{{ dept_type|lower }}">
    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0">
        {% if dept_type == "Academic" %}
          <i class="fas fa-graduation-cap me-2"></i>
        {% elif dept_type == "Staff" %}
          <i class="fas fa-user-tie me-2"></i>
        {% elif dept_type == "Library" %}
          <i class="fas fa-book me-2"></i>
        {% else %}
          <i class="fas fa-building me-2"></i>
        {% endif %}
        {{ dept_type }} Departments
        <span class="badge bg-secondary ms-2">{{ type_depts|length }} departments</span>
      </h5>
      <span class="text-muted small">
        {% set total_type_members = type_depts|sum(attribute='active_borrowers') %}
        {{ total_type_members }} active members
      </span>
    </div>
    
    <div class="card-body">
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3">
        {% for dept in type_depts %}
        <div class="col dept-card" 
             data-dept="{{ dept.dept_name }}"
             data-code="{{ dept.dept_code }}"
             data-type="{{ dept.type|lower }}"
             data-icon="{{ dept.icon }}">
          <div class="card h-100 shadow-sm border hover-lift">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h6 class="card-subtitle mb-1 text-muted">
                    <i class="fas fa-{{ dept.icon }} me-1"></i>
                    {{ dept.type }}
                    <span class="badge bg-light text-dark ms-1">{{ dept.dept_code }}</span>
                  </h6>
                  <h5 class="card-title mb-0">
                    {{ dept.dept_name }}
                    <small class="text-muted d-block">{{ dept.type }} Department</small>
                  </h5>
                </div>
                <span class="badge bg-primary">
                  <i class="fas fa-users me-1"></i>
                  {{ dept.active_borrowers }}
                </span>
              </div>
              
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <div class="small text-muted">Total Borrowers</div>
                  <div class="fw-bold">{{ dept.total_borrowers }}</div>
                </div>
                <div class="col-6">
                  <div class="small text-muted">AY Issues</div>
                  <div class="fw-bold text-success">{{ dept.ay_issues }}</div>
                </div>
                <div class="col-6">
                  <div class="small text-muted">Active Loans</div>
                  <div class="fw-bold text-info">{{ dept.active_loans }}</div>
                </div>
                <div class="col-6">
                  <div class="small text-muted">Overdues</div>
                  <div class="fw-bold text-warning">{{ dept.overdues }}</div>
                </div>
              </div>
              
              <!-- Department Policies -->
              {% if dept.enrolmentperiod or dept.overduefinescap %}
              <div class="mb-3">
                <div class="small text-muted">Department Policies:</div>
                <div class="d-flex flex-wrap gap-1">
                  {% if dept.enrolmentperiod %}
                  <span class="badge bg-info-subtle text-info-emphasis">
                    <i class="fas fa-calendar me-1"></i> {{ dept.enrolmentperiod }} days
                  </span>
                  {% endif %}
                  {% if dept.overduefinescap and dept.overduefinescap > 0 %}
                  <span class="badge bg-warning-subtle text-warning-emphasis">
                    <i class="fas fa-money-bill me-1"></i> {{ "%.2f"|format(dept.overduefinescap) }}
                  </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
              
              <!-- Department Statistics -->
              <div class="small text-muted mb-1">
                <i class="fas fa-chart-line me-1"></i>
                AY Fines: <strong class="text-dark">{{ "%.2f"|format(dept.ay_fines) }}</strong>
              </div>
              
              <div class="d-grid gap-2">
                <a href="{{ url_for('hod_dashboard_bp.dashboard', dept=dept.dept_code) }}"
                   class="btn btn-primary btn-sm">
                  <i class="fas fa-chart-bar me-1"></i>
                  View Dashboard
                </a>
                <button class="btn btn-outline-secondary btn-sm dept-details-btn" 
                        data-dept-code="{{ dept.dept_code }}"
                        data-dept-name="{{ dept.dept_name }}">
                  <i class="fas fa-info-circle me-1"></i>
                  Quick Info
                </button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- No Departments Message -->
  {% if total_departments == 0 %}
  <div class="text-center py-5">
    <i class="fas fa-building fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No Departments Found</h4>
    <p class="text-muted">There are no departments configured in the system.</p>
    <a href="{{ url_for('hod_dashboard_bp.dashboard') }}" class="btn btn-primary">
      <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
    </a>
  </div>
  {% endif %}

  <!-- No Results Message (hidden by default) -->
  <div id="noResults" class="text-center py-5" style="display: none;">
    <i class="fas fa-search fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No departments found</h4>
    <p class="text-muted">Try a different search term</p>
    <button class="btn btn-outline-secondary" onclick="clearSearch()">
      <i class="fas fa-times me-1"></i> Clear Search
    </button>
  </div>
</div>

<!-- Department Details Modal -->
<div class="modal fade" id="deptDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDeptName"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Borrowers</h6>
                <div class="d-flex align-items-center">
                  <i class="fas fa-users fa-2x text-primary me-3"></i>
                  <div>
                    <div class="fs-4 fw-bold" id="modalActiveBorrowers">0</div>
                    <div class="small text-muted">active / <span id="modalTotalBorrowers">0</span> total</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Academic Year Activity</h6>
                <div class="d-flex align-items-center">
                  <i class="fas fa-book fa-2x text-success me-3"></i>
                  <div>
                    <div class="fs-4 fw-bold" id="modalAyIssues">0</div>
                    <div class="small text-muted">books issued</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Fines Collected (AY)</h6>
                <div class="d-flex align-items-center">
                  <i class="fas fa-money-bill fa-2x text-warning me-3"></i>
                  <div>
                    <div class="fs-4 fw-bold" id="modalAyFines">0</div>
                    <div class="small text-muted">total fines paid</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-body">
                <h6 class="card-subtitle mb-2 text-muted">Current Status</h6>
                <div class="d-flex align-items-center">
                  <i class="fas fa-clock fa-2x text-danger me-3"></i>
                  <div>
                    <div class="fs-4 fw-bold" id="modalOverdues">0</div>
                    <div class="small text-muted">overdue items</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <h6 class="text-muted mb-2">Department Classes:</h6>
          <div id="deptClassesList" class="text-muted small">
            Loading classes...
          </div>
        </div>
        
        <div class="text-center">
          <a href="#" id="modalDashboardLink" class="btn btn-primary me-2">
            <i class="fas fa-chart-bar me-1"></i>
            Open Full Dashboard
          </a>
          <a href="#" id="modalReportLink" class="btn btn-outline-danger me-2">
            <i class="fas fa-download me-1"></i>
            Download Report
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .dept-card .card {
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
  }
  
  .dept-card .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
    border-color: #1976d2;
  }
  
  .hover-lift:hover {
    transform: translateY(-3px);
    transition: transform 0.2s ease;
  }
  
  .dept-type-section {
    transition: all 0.3s ease;
  }
  
  .bg-pink {
    background: linear-gradient(135deg, #ec4899 0%, #db2777 100%) !important;
  }
  
  .badge {
    font-weight: 500;
  }
  
  .dept-card .card-title small {
    font-size: 0.8rem;
    display: block;
    margin-top: 2px;
  }
  
  /* Department type specific colors */
  .card-subtitle .fa-graduation-cap {
    color: #198754; /* Success green for academic departments */
  }
  
  .card-subtitle .fa-user-tie {
    color: #0dcaf0; /* Info blue for staff departments */
  }
  
  .card-subtitle .fa-book {
    color: #ffc107; /* Warning yellow for library departments */
  }
  
  .card-subtitle .fa-building {
    color: #6c757d; /* Secondary gray for other departments */
  }
  
  /* Loading animation for modal */
  .loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Clear search function
  function clearSearch() {
    document.getElementById('departmentSearch').value = '';
    document.getElementById('departmentSearch').dispatchEvent(new Event('input'));
  }
  
  // Initialize department type counts
  function updateDeptTypeCounts() {
    const academicCount = document.querySelectorAll('.dept-card[data-type*="academic"]').length;
    const staffCount = document.querySelectorAll('.dept-card[data-type*="staff"]').length;
    
    // Calculate total members
    let totalMembers = 0;
    document.querySelectorAll('.dept-card .badge.bg-primary').forEach(badge => {
      const memberCount = parseInt(badge.textContent.match(/\d+/)?.[0] || 0);
      totalMembers += memberCount;
    });
    
    // Update counters
    document.getElementById('academicDeptCount').textContent = academicCount;
    document.getElementById('staffDeptCount').textContent = staffCount;
    document.getElementById('totalMembers').textContent = totalMembers;
  }
  
  // Department search functionality
  document.getElementById('departmentSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    let visibleCount = 0;
    
    document.querySelectorAll('.dept-card').forEach(card => {
      const deptName = card.getAttribute('data-dept').toLowerCase();
      const deptCode = card.getAttribute('data-code').toLowerCase();
      const deptType = card.getAttribute('data-type').toLowerCase();
      
      const matches = deptName.includes(searchTerm) || 
                     deptCode.includes(searchTerm) || 
                     deptType.includes(searchTerm) ||
                     searchTerm === '';
      
      card.style.display = matches ? 'block' : 'none';
      if (matches) visibleCount++;
    });
    
    // Show/hide department type sections based on visible cards
    document.querySelectorAll('.dept-type-section').forEach(section => {
      const deptType = section.getAttribute('data-type');
      const visibleInSection = section.querySelectorAll('.dept-card[style*="block"]').length;
      section.style.display = visibleInSection > 0 ? 'block' : 'none';
    });
    
    // Show no results message if needed
    document.getElementById('noResults').style.display = visibleCount === 0 && searchTerm !== '' ? 'block' : 'none';
    
    updateDeptTypeCounts();
  });
  
  // Show department details modal
  async function showDeptDetails(deptCode, deptName) {
    try {
      // Set modal title and basic links
      document.getElementById('modalDeptName').textContent = deptName;
      document.getElementById('modalDashboardLink').href = `/hod_dashboard?dept=${encodeURIComponent(deptCode)}`;
      document.getElementById('modalReportLink').href = `/hod_dashboard/download/department/pdf?dept=${encodeURIComponent(deptCode)}`;
      
      // Show loading state
      document.getElementById('modalActiveBorrowers').innerHTML = '<span class="loading-spinner"></span>';
      document.getElementById('modalTotalBorrowers').textContent = '...';
      document.getElementById('modalAyIssues').innerHTML = '<span class="loading-spinner"></span>';
      document.getElementById('modalAyFines').innerHTML = '<span class="loading-spinner"></span>';
      document.getElementById('modalOverdues').innerHTML = '<span class="loading-spinner"></span>';
      document.getElementById('deptClassesList').innerHTML = '<span class="loading-spinner"></span> Loading classes...';
      
      // Fetch department details via API
      const response = await fetch(`/hod_dashboard/api/department/${encodeURIComponent(deptCode)}`);
      
      if (response.ok) {
        const data = await response.json();
        
        // Update modal with department stats
        if (data.success) {
          const stats = data.stats;
          const deptInfo = data.dept_info;
          
          document.getElementById('modalTotalBorrowers').textContent = stats.total_borrowers || 0;
          document.getElementById('modalActiveBorrowers').textContent = stats.active_borrowers || 0;
          document.getElementById('modalAyIssues').textContent = stats.ay_issues || 0;
          document.getElementById('modalAyFines').textContent = stats.ay_fines ? stats.ay_fines.toFixed(2) : '0.00';
          document.getElementById('modalOverdues').textContent = stats.overdues || 0;
          
          // Update classes list
          const classesList = document.getElementById('deptClassesList');
          if (data.classes && data.classes.length > 0) {
            const classesHtml = data.classes.map(cls => 
              `<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                <div>
                  <strong>${cls.display || cls.name}</strong>
                  <div class="small mt-1">
                    ${cls.year ? `<span class="badge bg-light text-dark me-1">Year ${cls.year}</span>` : ''}
                    ${cls.section ? `<span class="badge bg-info me-1">Section ${cls.section}</span>` : ''}
                    ${cls.gender ? `<span class="badge bg-primary me-1">${cls.gender}</span>` : ''}
                    ${cls.is_arabic ? `<span class="badge bg-success">Arabic</span>` : ''}
                  </div>
                </div>
                <div class="small text-muted">${cls.name}</div>
              </div>`
            ).join('');
            classesList.innerHTML = classesHtml;
          } else {
            classesList.innerHTML = '<div class="alert alert-light text-center">No classes found in this department</div>';
          }
          
          // Add department info if available
          if (deptInfo) {
            const extraInfo = document.createElement('div');
            extraInfo.className = 'small text-muted mt-3';
            extraInfo.innerHTML = `
              <div class="d-flex justify-content-between">
                <span><i class="fas fa-calendar me-1"></i> Enrolment: ${deptInfo.enrolmentperiod || 'N/A'} days</span>
                <span><i class="fas fa-money-bill me-1"></i> Fines cap: ${deptInfo.overduefinescap || 'N/A'}</span>
              </div>
            `;
            classesList.appendChild(extraInfo);
          }
        } else {
          throw new Error(data.error || 'Failed to fetch department details');
        }
      } else {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
    } catch (error) {
      console.error('Error fetching department details:', error);
      
      // Show error message
      document.getElementById('deptClassesList').innerHTML = 
        `<div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Unable to load department details. Please try again.
        </div>`;
        
      // Set default values
      document.getElementById('modalActiveBorrowers').textContent = 'Error';
      document.getElementById('modalTotalBorrowers').textContent = 'Error';
      document.getElementById('modalAyIssues').textContent = 'Error';
      document.getElementById('modalAyFines').textContent = 'Error';
      document.getElementById('modalOverdues').textContent = 'Error';
    }
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('deptDetailsModal'));
    modal.show();
  }
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    // Set up department detail buttons
    document.querySelectorAll('.dept-details-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const deptCode = this.getAttribute('data-dept-code');
        const deptName = this.getAttribute('data-dept-name');
        showDeptDetails(deptCode, deptName);
      });
    });
    
    // Add click handler for department cards (excluding buttons)
    document.querySelectorAll('.dept-card .card').forEach(card => {
      card.addEventListener('click', function(e) {
        // Don't trigger if clicking on buttons or links
        if (!e.target.closest('a') && !e.target.closest('button')) {
          const deptCode = this.closest('.dept-card').getAttribute('data-code');
          window.location.href = `/hod_dashboard?dept=${encodeURIComponent(deptCode)}`;
        }
      });
    });
    
    // Update search placeholder
    document.getElementById('departmentSearch').placeholder = "Search departments (name, code, or type)...";
    
    // Initialize counters
    updateDeptTypeCounts();
    
    // Add keyboard shortcut for search (Ctrl+F)
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        document.getElementById('departmentSearch').focus();
      }
    });
    
    // Focus search on page load
    setTimeout(() => {
      document.getElementById('departmentSearch').focus();
    }, 100);
  });
</script>
{% endblock %}