{% extends "base.html" %}
{% block title %}Department Search Results â€” Maktabat al-Jamea{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2 class="text-center">ğŸ” Search Results for â€œ{{ query }}â€</h2>
  <p class="text-muted text-center mb-3">
    Department: <strong>{{ dept_name }}</strong>
  </p>

  <!-- Back button -->
  <div class="text-start mb-3">
    <a href="{{ url_for('hod_dashboard_bp.dashboard') }}" class="btn btn-outline-secondary btn-sm">
      â† Back to Dashboard
    </a>
  </div>

  <!-- === STUDENT RESULTS === -->
  {% if students %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      ğŸ‘©â€ğŸ“ Student Matches
      <span class="badge bg-primary">{{ students|length }} found</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>TR Number</th>
            <th>Full Name</th>
            <th>Class</th>
            <th class="text-center">Issues (AY)</th>
            <th class="text-center">Fines Paid (AY)</th>
            <th class="text-center">Active Loans</th>
            <th class="text-center">Overdues</th>
            <th class="text-center">Download</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          {% set tr = s.get('TRNumber') or s.get('TRNO') %}
          <tr>
            <td>{{ tr or 'â€”' }}</td>
            <td>
              {% if tr %}
                <a href="{{ url_for('students_bp.student', identifier=tr) }}"
                   class="link-primary text-decoration-none">
                  {{ s.get('FullName') or 'â€”' }}
                </a>
              {% else %}
                {{ s.get('FullName') or 'â€”' }}
              {% endif %}
            </td>
            <td>{{ s.get('Class') or s.get('STD') or 'â€”' }}</td>
            <td class="text-center">{{ s.get('Issues_AY', 0) }}</td>
            <td class="text-center">{{ "%.2f"|format(s.get('FinesPaid_AY', 0) or 0) }}</td>
            <td class="text-center">{{ s.get('ActiveLoans', 0) }}</td>
            <td class="text-center">{{ s.get('Overdues', 0) }}</td>
            <td class="text-center">
              {% if tr %}
              <a href="{{ url_for('hod_dashboard_bp.download_student_pdf', identifier=tr) }}"
                 class="btn btn-sm btn-outline-success">
                â¬‡ï¸ PDF
              </a>
              {% else %}
              <span class="text-muted small">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- === CLASS RESULTS === -->
  {% if classes %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      ğŸ« Class Matches
      <span class="badge bg-success">{{ classes|length }} found</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Class Name</th>
            <th class="text-center">Total Students</th>
            <th class="text-center">Issues (AY)</th>
            <th class="text-center">Fines Paid (AY)</th>
            <th class="text-center">Active Loans</th>
            <th class="text-center">Overdues</th>
            <th class="text-center">Download</th>
          </tr>
        </thead>
        <tbody>
          {% for c in classes %}
          {% set cname = c.get('ClassName') or c.get('Class') or c.get('STD') or 'â€”' %}
          <tr>
            <td>{{ cname }}</td>
            <td class="text-center">{{ c.get('StudentCount', 0) }}</td>
            <td class="text-center">{{ c.get('Issues_AY', 0) }}</td>
            <td class="text-center">{{ "%.2f"|format(c.get('FinesPaid_AY', 0) or 0) }}</td>
            <td class="text-center">{{ c.get('ActiveLoans', 0) }}</td>
            <td class="text-center">{{ c.get('Overdues', 0) }}</td>
            <td class="text-center">
              {% if cname and cname != 'â€”' %}
              <a href="{{ url_for('hod_dashboard_bp.download_class_pdf', class_name=cname) }}"
                 class="btn btn-sm btn-outline-primary">
                â¬‡ï¸ PDF
              </a>
              {% else %}
              <span class="text-muted small">â€”</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if not students and not classes %}
  <div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    No matching students or classes found for your search.
  </div>
  {% endif %}
</div>

{% endblock %}
