{% extends "base.html" %}
{% block title %}Department Search Results â€” Maktabat al-Jamea{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2>ğŸ” Search Results for â€œ{{ query }}â€</h2>
  <p class="text-muted">Department: <strong>{{ dept_name }}</strong></p>

  <!-- Back button -->
  <a href="{{ url_for('hod_dashboard_bp.dashboard') }}" class="btn btn-outline-secondary btn-sm mb-3">
    â† Back to Dashboard
  </a>

  <!-- === STUDENT RESULTS === -->
  {% if students %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      ğŸ‘©â€ğŸ“ Student Matches
      <span class="badge bg-primary">{{ students|length }} found</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>TR Number</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Issues (AY)</th>
            <th>Fines Paid</th>
            <th>Active Loans</th>
            <th>Overdues</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td>{{ s.get('TRNumber') or s.get('TRNO') or 'â€”' }}</td>
            <td>{{ s.get('FullName') or 'â€”' }}</td>
            <td>{{ s.get('Class') or s.get('STD') or 'â€”' }}</td>
            <td>{{ s.get('Issues_AY', 0) }}</td>
            <td>{{ "%.2f"|format(s.get('FinesPaid_AY', 0)) }}</td>
            <td>{{ s.get('ActiveLoans', 0) }}</td>
            <td>{{ s.get('Overdues', 0) }}</td>
            <td>
              <a href="{{ url_for('hod_dashboard_bp.download_student_pdf', identifier=s.get('TRNumber') or s.get('TRNO')) }}"
                 class="btn btn-sm btn-outline-success">
                â¬‡ï¸ PDF
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <!-- === CLASS RESULTS === -->
  {% if classes %}
  <div class="card shadow-sm mb-4">
    <div class="card-header fw-bold d-flex justify-content-between align-items-center">
      ğŸ« Class Matches
      <span class="badge bg-success">{{ classes|length }} found</span>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Class Name</th>
            <th>Total Students</th>
            <th>Issues (AY)</th>
            <th>Fines Paid</th>
            <th>Active Loans</th>
            <th>Overdues</th>
            <th>Download</th>
          </tr>
        </thead>
        <tbody>
          {% for c in classes %}
          <tr>
            <td>{{ c.get('ClassName') or c.get('Class') or c.get('STD') or 'â€”' }}</td>
            <td>{{ c.get('StudentCount', 0) }}</td>
            <td>{{ c.get('Issues_AY', 0) }}</td>
            <td>{{ "%.2f"|format(c.get('FinesPaid_AY', 0)) }}</td>
            <td>{{ c.get('ActiveLoans', 0) }}</td>
            <td>{{ c.get('Overdues', 0) }}</td>
            <td>
              <a href="{{ url_for('hod_dashboard_bp.download_class_pdf', class_name=c.get('ClassName') or c.get('Class')) }}"
                 class="btn btn-sm btn-outline-primary">
                â¬‡ï¸ PDF
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if not students and not classes %}
  <div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    No matching students or classes found for your search.
  </div>
  {% endif %}
</div>

{% endblock %}
